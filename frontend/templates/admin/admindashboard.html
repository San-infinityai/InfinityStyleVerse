<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard | InfinityStyleVerse</title>
  <link rel="stylesheet" href="../../assets/css/admin_dashboard.css">
</head>
<body>
  <div class="admin-container">
    <h1>Admin Dashboard</h1>

    <!-- Filter Buttons -->
    <div class="filters">
      <button onclick="filterUsers('all')">All</button>
      <button onclick="filterUsers('Creator')">Creators</button>
      <button onclick="filterUsers('Customer')">Customers</button>
      <button onclick="filterUsers('Inactive')">Inactive</button>
    </div>

    <!-- Users Table -->
    <table id="user-table">
      <thead>
        <tr>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    async function fetchUsers() {
      try {
        const response = await fetch('http://localhost:5000/admin/users');
        let users = await response.json();

        // Remove Admin users
        users = users.filter(user => user.role.toLowerCase() !== 'admin');
        renderUsers(users);
      } catch (error) {
        console.error("Error fetching users:", error);
        alert("Failed to load users.");
      }
    }

    function renderUsers(users) {
      const tbody = document.querySelector('#user-table tbody');
      tbody.innerHTML = '';

      users.forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${user.email}</td>
          <td>${user.role}</td>
          <td>${user.status}</td>
          <td>
            <button onclick="editUser(${user.id}, '${user.email}', '${user.role}')">Edit</button>
            <button onclick="deleteUser(${user.id})">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filterUsers(role) {
      fetchUsers().then(() => {
        const rows = document.querySelectorAll('#user-table tbody tr');
        rows.forEach(row => {
          const userRole = row.children[1].innerText;
          const userStatus = row.children[2].innerText;

          if (role === 'all') {
            row.style.display = '';
          } else if (role === 'Inactive') {
            row.style.display = userStatus === 'Inactive' ? '' : 'none';
          } else {
            row.style.display = userRole === role ? '' : 'none';
          }
        });
      });
    }

    function deleteUser(userId) {
      if (confirm("Are you sure you want to delete this user?")) {
        fetch(`/admin/users/${userId}`, {
          method: 'DELETE'
        })
        .then(res => res.json())
        .then(data => {
          alert(data.msg);
          fetchUsers();
        })
        .catch(error => {
          console.error("Delete failed:", error);
          alert("Failed to delete user.");
        });
      }
    }

    function editUser(userId, oldEmail, oldRole) {
      const newEmail = prompt("Edit Email:", oldEmail);
      const newRole = prompt("Edit Role (Creator/Customer):", oldRole);

      if (newEmail && newRole) {
        fetch(`/admin/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email: newEmail, role: newRole })
        })
        .then(res => res.json())
        .then(data => {
          alert(data.msg);
          fetchUsers();
        })
        .catch(error => {
          console.error("Edit failed:", error);
          alert("Failed to update user.");
        });
      }
    }

    window.onload = fetchUsers;
  </script>
</body>
</html>
